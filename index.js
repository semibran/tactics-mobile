"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],a=!0,n=!1,i=void 0;try{for(var l,s=e[Symbol.iterator]();!(a=(l=s.next()).done)&&(r.push(l.value),!t||r.length!==t);a=!0);}catch(e){n=!0,i=e}finally{try{!a&&s.return&&s.return()}finally{if(n)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(){var a={piece:{shadow:[512,80,14,14],base:[559,560,16,16]},tiles:{grass:[322,572,16,16]},effects:{shockwave:[0,560,160,24],attack:[160,560,192,12]},ui:{cursor:[512,512,32,16],box:[464,512,48,48],squares:[512,64,32,16],ring:[0,512,384,48],arrows:[512,0,64,64],healthbar:[384,576,48,8],words:{player:[464,560,95,16],phase:[242,572,80,16],enemy:[160,572,82,16]},typeface:[384,512,80,64],circle:[352,560,16,16]},maps:{test:[256,0,256,512],"test-tree":[0,0,256,512]},icons:{target:[576,0,8,8],cursor:[464,576,8,8],checkmark:[544,64,8,8],wing:[512,528,8,8],dragon:[544,512,8,8],viking:[432,576,8,8],shield:[534,80,8,8],bow:[368,560,8,8],fuse:[559,576,8,8],element:[575,560,8,8],book:[338,572,8,8],boot:[512,94,8,8],puzzle:[526,80,8,8],"axe-2":[576,8,8,8],ice:[472,576,8,8],fire:[544,72,8,8],muscle:[552,64,8,8],dagger:[512,536,8,8],sword:[520,528,8,8],arrow:[544,520,8,8],sabre:[552,512,8,8],helmet:[440,576,8,8],thunder:[360,576,8,8],next:[368,568,8,8],eye:[376,560,8,8],clock:[567,576,8,8],axe:[575,568,8,8],"hat-2":[338,580,8,8],hat:[512,102,8,8],enemy:[520,94,8,8],lance:[352,576,8,8]}},yt=function(e,t,r,a,n){t||(t=0),r||(r=0),a||(a=e.width),n||(n=e.height);var i=document.createElement("canvas"),l=i.getContext("2d");return i.width=a,i.height=n,l.drawImage(e,-t,-r),i};function xt(e,t){var r=document.createElement("canvas"),a=r.getContext("2d");return r.width=e,r.height=t,a}var c={get:function(e,t,r){var a=4*(r*e.width+t),n=e.data[a],i=e.data[a+1],l=e.data[a+2],s=e.data[a+3];return[n,i,l,s]},set:function(e,t,r,a){var n=4*(r*e.width+t);e.data[n+0]=a[0],e.data[n+1]=a[1],e.data[n+2]=a[2],e.data[n+3]=a[3]},replace:function(e,t,r){for(var a=0;a<e.data.length;a+=4){for(var n=0;n<4&&e.data[a+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[a+n]=r[n]}}},v={black:[0,0,0,255],gray:[168,168,168,255],white:[255,255,255,255],cyan:[144,224,232,255],blue:[80,120,248,255],navy:[88,24,216,255],pink:[248,192,224,255],red:[208,0,88,255],purple:[56,0,80,255],lime:[200,224,144,255],green:[40,192,32,255],teal:[0,96,112,255],yellow:[232,224,56,255]},bt={fighter:"axe",knight:"shield",thief:"dagger",mage:"hat",berserker:"viking",general:"helmet",assassin:"sabre",sorcerer:"hat-2"};function o(e,t,r){e=e.getContext("2d").getImageData(0,0,16,16),t=t.getContext("2d").getImageData(0,0,t.width,t.height),c.replace(e,v.white,r.default),c.replace(e,v.black,r.dark);var a=xt(e.width,e.height);a.putImageData(e,0,0);var n=xt(8,8);c.replace(t,v.white,r.light),n.putImageData(t,0,0),a.drawImage(n.canvas,4,4);var i,l,s,o,u=xt(8,8);return c.replace(t,r.light,r.dark),u.putImageData(t,0,0),a.drawImage(u.canvas,4,3),i=a.canvas,l=4,s=document.createElement("canvas"),o=s.getContext("2d"),s.width=i.width*l,s.height=i.height*l,o.webkitImageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,o.msImageSmoothingEnabled=!1,o.imageSmoothingEnabled=!1,o.drawImage(i,0,0,i.width*l,i.height*l),s}function kt(e){for(var t=1/0,r=1/0,a=-1/0,n=-1/0,i=0;i<e.length;i++){var l=e[i],s=l[0],o=l[1];s<t&&(t=s),a<s&&(a=s),o<r&&(r=o),n<o&&(n=o)}return{left:t,top:r,right:a,bottom:n,width:a-t+1,height:n-r+1}}var h=function(e,t,r,a,n){var i=document.createElement("canvas"),l=i.getContext("2d");return i.width=a,i.height=n,l.drawImage(e,-t,-r),i};function n(e){var t,a,r,O,n,s,i,l,o=(t=e.ui.cursor,[h(t,0,0,16,16),h(t,16,0,16,16)]),u=(a=e.ui.circle,function(e){var t=yt(a),r=t.getContext("2d");return t.className="button",r.drawImage(e,4,4),t}),c=(r=e.ui.arrows,O={left:h(r,0,0,16,16),right:h(r,16,0,16,16),up:h(r,32,0,16,16),down:h(r,48,0,16,16),leftStub:h(r,0,16,16,16),rightStub:h(r,16,16,16,16),upStub:h(r,32,16,16,16),downStub:h(r,48,16,16,16),upLeft:h(r,0,32,16,16),upRight:h(r,16,32,16,16),downLeft:h(r,32,32,16,16),downRight:h(r,48,32,16,16),horiz:h(r,0,48,16,16),vert:h(r,16,48,16,16)},function(e){for(var t=[],r=0;r<e.length;r++){var a=_slicedToArray(e[r],2),n=a[0],i=a[1],l=!1,s=!1,o=!1,u=!1,c=e[r-1];if(c){var p=n-c[0],f=i-c[1];1===p?l=!0:-1===p&&(s=!0),1===f?o=!0:-1===f&&(u=!0)}var v=e[r+1];if(v){var h=v[0]-n,d=v[1]-i;-1===h?l=!0:1===h&&(s=!0),-1===d?o=!0:1===d&&(u=!0)}if(l||s||o||u){var g=null;l&&s?g="horiz":o&&u?g="vert":o&&l?g="upLeft":o&&s?g="upRight":u&&l?g="downLeft":u&&s?g="downRight":l&&!r?g="leftStub":s&&!r?g="rightStub":o&&!r?g="upStub":u&&!r?g="downStub":l?g="left":s?g="right":o?g="up":u&&(g="down"),g&&t.push({sprite:O[g],position:[n,i]})}}var m=kt(e),w=xt(16*m.width,16*m.height),y=!0,x=!1,b=void 0;try{for(var k,C=t[Symbol.iterator]();!(y=(k=C.next()).done);y=!0){var I=k.value,z=I.sprite,A=I.position,M=_slicedToArray(A,2),S=M[0],E=M[1];w.drawImage(z,16*(S-m.left),16*(E-m.top))}}catch(e){x=!0,b=e}finally{try{!y&&C.return&&C.return()}finally{if(x)throw b}}return w.canvas}),p=function(e){for(var t=e.width/8,r=e.height/8,o={},a=0,n=0;n<r;n++)for(var i=0;i<t;i++){var l="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/-+     "[a++];o[l]=h(e,8*i,8*n,8,8)}return function(e){for(var t=0,r=0;r<e.length;r++)" "===e[r]?t+=4:t+=8;for(var a=xt(t,8),n=0,i=0;n<e.length;n++){var l=e[n];if(" "===l)i+=4;else{var s=o[l];a.drawImage(s,i,0),i+=8}}return a.canvas}}(e.ui.typeface),f=(n=e.ui.box,s={topLeft:h(n,0,0,16,16),top:h(n,16,0,16,16),topRight:h(n,32,0,16,16),left:h(n,0,16,16,16),center:h(n,16,16,16,16),right:h(n,32,16,16,16),bottomLeft:h(n,0,32,16,16),bottom:h(n,16,32,16,16),bottomRight:h(n,32,32,16,16)},function(e,t){for(var r=Math.ceil(e/16),a=Math.ceil(t/16),n=xt(e,t),i=1;i<r-1;i++)n.drawImage(s.top,16*i,0),n.drawImage(s.bottom,16*i,t-16);for(var l=1;l<a-1;l++)n.drawImage(s.left,0,16*l),n.drawImage(s.right,e-16,16*l);return n.fillRect(4,4,e-8,t-8),n.drawImage(s.topLeft,0,0),n.drawImage(s.topRight,e-16,0),n.drawImage(s.bottomLeft,0,t-16),n.drawImage(s.bottomRight,e-16,t-16),n.canvas});return{Text:p,Box:f,TextBox:(i=p,l=f,function(e){var t=i(e),r=t.width,a=l(r+16,24),n=xt(r,8);return n.drawImage(t,0,0),n.canvas.width&&a.getContext("2d").drawImage(n.canvas,8,8),a}),Arrow:c,Button:u,squares:function(){return{move:e(v.blue),attack:e(v.red),fuse:e(v.yellow)};function e(e){var t=xt(16,16);return t.fillStyle=function(e,t,r,a){return"rgba("+e+", "+t+", "+r+", "+a+")"}.apply(void 0,_toConsumableArray(e)),t.globalAlpha=.5,t.fillRect(0,0,15,15),t.canvas}}(),ring:function(e){for(var t=e.width/48,r=new Array(t),a=0;a<t;a++)r[a]=h(e,48*a,0,48,48);return r}(e.ui.ring),cursor:o}}function i(e){var t=function e(t,r){var a={};for(var n in r)if(Array.isArray(r[n])){var i=_slicedToArray(r[n],4),l=i[0],s=i[1],o=i[2],u=i[3];a[n]=yt(t,l,s,o,u)}else a[n]=e(t,r[n]);return a}(e,a),r=function(e){var t={},r={player:{default:v.blue,light:v.cyan,dark:v.navy},enemy:{default:v.red,light:v.pink,dark:v.purple}};for(var a in r){var n=r[a];for(var i in bt){var l=bt[i],s=e.icons[l];t[i]||(t[i]={}),t[i][a]=o(e.piece.base,s,n)}}return t}(t);return{Piece:function(e,t){return yt(r[e][t])},pieces:{shadow:t.piece.shadow},ui:n(t),effects:t.effects,tiles:t.tiles,icons:t.icons}}var t={name:"grass",walkable:!0},e={id:"test",map:{size:[12,16],data:"                                                                                                                                                                                                ".split("").map(function(e){switch(e){case" ":return t}})},units:[["Ulysses","knight","player",null,[4,6]],["Alice","mage","player",null,[3,9]],["Garrick","fighter","enemy",null,[8,7]]]};function m(e){var t=document.createElement("div");return t.className=e,t}var r={axe:{type:"axe",stat:"str",atk:2,hit:0,rng:1},lance:{type:"lance",stat:"str",atk:2,hit:1,rng:1},dagger:{type:"dagger",stat:"str",atk:1,hit:1,rng:1},tome:{type:"tome",stat:"int",atk:2,hit:1,rng:2}},l={leather:{def:1,wt:0},mail:{def:2,wt:1},plate:{def:3,wt:1}};function w(e,t){return e.faction===t.faction}function y(e){var t=u[e].armor,r=t?t.wt:0;return 5+Math.floor(s[e].agi/3-r/2)}function Ct(e){return(t=e,u[t].weapon).rng;var t}var s={fighter:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:1},thief:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},u={fighter:{weapon:r.axe,armor:l.leather},knight:{weapon:r.lance,armor:l.mail},thief:{weapon:r.dagger,armor:l.leather},mage:{weapon:r.tome,armor:l.leather},berserker:{weapon:r.axe,armor:l.leather},general:{weapon:r.lance,armor:l.plate},assassin:{weapon:r.dagger,armor:l.leather},sorcerer:{weapon:r.tome,armor:l.leather}};function x(e,t){return Math.abs(p(t)-p(e))+Math.abs(f(t)-f(e))}function p(e){return e[0]}function f(e){return e[1]}function It(e,t){return p(e)===p(t)&&f(e)===f(t)}function zt(e,t){for(var r=0;r<e.length;r++)if(It(e[r],t))return r;return-1}function At(e,t){t||(t=1);for(var r=[{steps:0,cell:e}],a=[];r.length;)for(var n=r.shift(),i=[[p(n.cell)-1,f(n.cell)],[p(n.cell)+1,f(n.cell)],[p(n.cell),f(n.cell)-1],[p(n.cell),f(n.cell)+1]],l=0;l<i.length;l++){var s=i[l];It(e,s)||-1!==zt(a,s)||(a.push(s),n.steps+1<t&&r.push({steps:n.steps+1,cell:s}))}return a}function Mt(e,t){var r={move:[t.cell],attack:[],fuse:[]},a="defend"===t.ai?0:y(t.type),n=[{steps:0,cell:t.cell}],i=[];for(a||(n.length=0,i.push(t.cell));n.length;)for(var l=n.shift(),s=At(l.cell),o=0;o<s.length;o++){if(b(e,p=s[o])&&-1===zt(r.move,p)){if(f=St(e,p)){var u=w(t,f)?r.fuse:r.attack;f.type!==t.type&&u===r.fuse||-1===zt(u,p)&&u.push(p)}else r.move.push(p);l.steps<a-1?f&&!w(t,f)||n.push({steps:l.steps+1,cell:p}):i.push(p)}}for(o=0;o<i.length;o++){s=At(i[o],Ct(t.type));for(var c=0;c<s.length;c++){var p,f;if(g(e,p=s[c])&&b(e,p)&&!It(t.cell,p))(f=St(e,p))&&w(t,f)||-1===zt(r.attack,p)&&r.attack.push(p),(!f||w(t,f)&&t.type===f.type)&&-1===zt(r.fuse,p)&&r.fuse.push(p)}}return r}function d(e){return e.layout.size[0]}function g(e,t){return 0<=p(t)&&p(t)<d(e)&&0<=f(t)&&f(t)<e.layout.size[1]}function St(e,t){for(var r=0;r<e.units.length;r++){var a=e.units[r];if(It(a.cell,t))return a}}function b(e,t){return g(e,t)&&(r=e,a=t,r.layout.data[f(a)*d(r)+p(a)]).walkable;var r,a}function k(e,t,r){for(var a=[],n=[t],i={},l={},s={},o={},u={},c=0;c<e.length;c++){var p=e[c];o[p]=1/0,u[p]=1/0}for(o[t]=0,u[t]=x(t,r);n.length;){var f={score:1/0,index:-1,cell:null};for(c=0;c<n.length;c++){(d=u[v=n[c]])<f.score&&(f.score=d,f.index=c,f.cell=v)}var v;if(It(v=f.cell,r)){for(;!It(v,t);)a.unshift(v),v=s[v];return a.unshift(v),a}n.splice(f.index,1),i[v]=!1,l[v]=!0;var h=At(v);for(c=0;c<h.length;c++){var d,g=h[c];if(-1!==zt(e,g))if(!l[g])i[g]||(i[g]=!0,n.push(g)),(d=o[v]+1)>=o[g]||(s[g]=v,o[g]=d,u[g]=d+x(g,r))}}return[]}function L(e,r,t,a,n){if(It(t,r.cell))return[t];var i=a.move.slice(),l=!0,s=!1,o=void 0;try{for(var u,c=e.units[Symbol.iterator]();!(l=(u=c.next()).done);l=!0){var p=u.value;w(r,p)&&!It(r.cell,p.cell)&&(x(r.cell,p.cell)>y(r.type)||i.push(p.cell))}}catch(e){s=!0,o=e}finally{try{!l&&c.return&&c.return()}finally{if(s)throw o}}var f=t,v=St(e,t);if(v){var h=w(r,v)?At(v.cell):At(v.cell,Ct(r.type));if(n){var d=h.filter(function(e){return-1!==zt(n,e)});d.length&&(f=d.sort(function(e,t){return n.indexOf(e)-n.indexOf(t)})[0])}if(!f)f=h.filter(function(e){return-1!==zt(i,e)}).sort(function(e,t){return x(r.cell,e)-x(r.cell,t)})[0]}if(!n)return k(i,r.cell,f);if(It(f,n[n.length-1]))return n;var g=zt(n,f);if(-1!==g)return n.slice(0,g+1);var m=k(i.filter(function(e){return-1===zt(n,e)}),n[n.length-1],f);return m.length?m&&n.length+m.length-2<=y(r.type)?(m.shift(),[].concat(_toConsumableArray(n),_toConsumableArray(m))):k(i,r.cell,f):[]}function Et(e,t){var r=t*(e.length-1),a=Math.floor(r),n=r-a;if(1===t)return e[a];var i=e[a],l=e[a+1];return[i[0]+(l[0]-i[0])*n,i[1]+(l[1]-i[1])*n]}var C,H=2;function I(e,t){var r=e.state,a=(e.actions,{sprites:t,element:document.createElement("main"),state:{time:0,cursor:{pos:null,drag:null},viewport:{size:[window.innerWidth/H,window.innerHeight/H],pos:[0,0],dest:null},modes:[],anims:[],cache:{box:null,layers:{},ranges:[],modes:[],units:[],cursor:{cell:null,unit:null}}}});return function(t,r,e){var L=t.state,R=r.map,a=t.sprites,N=L.cursor,T=L.viewport,_=L.modes,B=(L.anims,L.cache),D=B.layers;D.game=m("game"),D.map=function(e,t){var r=16*t.layout.size[0],a=16*t.layout.size[1],n=xt(r,a);n.canvas.className="map";for(var i=0;i<t.layout.size[1];i++)for(var l=0;l<t.layout.size[0];l++)n.drawImage(e.tiles.grass,16*l,16*i);return n.canvas}(a,R),D.ui=m("ui");var n=R.units[0];if(n){var i=-j(n.cell[0]),l=-j(n.cell[1]);T.pos=[i,l],Lt(t,r)}D.shadows=A("shadows"),D.squares=A("squares"),D.boxes=A("boxes"),D.buttons=A("buttons"),D.ring=A("ring"),D.markers={wrap:m("layer markers"),arrow:null,cursor:null},D.pieces={wrap:m("layer pieces"),list:[],selection:{z:0}},D.selection={wrap:m("layer selection"),piece:null,z:0};var s=!0,o=!1,u=void 0;try{for(var c,p=R.units[Symbol.iterator]();!(s=(c=p.next()).done);s=!0){var f=c.value,v=16*f.cell[0],h=16*f.cell[1],d=a.Piece(f.type,f.faction);d.className="piece",d.style.left=v+"px",d.style.top=h-1+"px",D.pieces.wrap.appendChild(d),D.pieces.list.push(d);var g=yt(a.pieces.shadow);g.className="shadow",g.style.left=v+1+"px",g.style.top=h+3+"px",D.shadows.wrap.appendChild(g),D.shadows.list.push(g)}}catch(e){o=!0,u=e}finally{try{!s&&p.return&&p.return()}finally{if(o)throw u}}function P(e){var t=e.touches[0]||e.changedTouches[0];return[t.pageX/H,t.pageY/H]}function F(e){var t=D.game.getBoundingClientRect();return[e[0]-t.left/H,e[1]-t.top/H]}D.game.appendChild(D.map),D.game.appendChild(D.squares.wrap),D.game.appendChild(D.shadows.wrap),D.game.appendChild(D.pieces.wrap),D.game.appendChild(D.markers.wrap),D.game.appendChild(D.ring.wrap),D.game.appendChild(D.buttons.wrap),D.game.appendChild(D.selection.wrap),D.ui.appendChild(D.boxes.wrap),t.element.appendChild(D.game),t.element.appendChild(D.ui),function e(){z(t,r);requestAnimationFrame(e)}(),t.element.addEventListener("touchstart",function(e){var t=N.pos=P(e),r=N.cell=F(N.pos).map(W),a=St(R,r),n=R.units.indexOf(a),i=D.pieces.list[n],l=_[0];if(l){if(l&&"move"===l.type)if(a)a!==l.unit&&(_.length=0,D.pieces.wrap.appendChild(i),T.dest=null);else{var s=l.unit,o=R.units.indexOf(s),u=B.ranges[o];D.pieces.list[o];-1===zt(u.move,r)?_.shift():N.drag=[16*r[0]-t[0]+T.pos[0],16*r[1]-t[1]+T.pos[1]]}else if(l&&"act"===l.type){var c=null,p=!0,f=!1,v=void 0;try{for(var h,d=l.buttons[Symbol.iterator]();!(p=(h=d.next()).done);p=!0){var g=h.value,m=g.el.getBoundingClientRect(),w=m.width/2,y=m.left+w,x=m.top+w,b=Math.pow(y-N.pos[0]*H,2),k=Math.pow(x-N.pos[1]*H,2);if(b+k<w*w){c=g;break}}}catch(e){f=!0,v=e}finally{try{!p&&d.return&&d.return()}finally{if(f)throw v}}var C=l.unit;c&&"back"!==c.id||(C.cell=B.src);var I=R.units.indexOf(C),z=D.selection.wrap.children[0],A=D.shadows.wrap.children[I],M=16*C.cell[0],S=16*C.cell[1];z.style.left=M+"px",z.style.top=S-1+"px",A.style.left=M+1+"px",A.style.top=S+4+"px",T.dest=[-j(C.cell[0]),-j(C.cell[1])],_.length=0}}else if(a){var E=B.ranges[n];E||(E=B.ranges[n]=Mt(R,a)),_.push({type:"move",unit:a,path:[r],range:E,time:L.time});var O=-j(a.cell[0]),q=-j(a.cell[1]);T.dest=[O,q],N.drag=[parseInt(i.style.left)-t[0]+T.pos[0],parseInt(i.style.top)-t[1]+T.pos[1]]}else T.dest=null,N.drag=[T.pos[0]-t[0],T.pos[1]-t[1]]}),t.element.addEventListener("touchmove",function(e){e.preventDefault(),N.pos=P(e),N.cell=F(N.pos).map(W)}),t.element.addEventListener("touchend",function(e){N.pos=P(e),N.cell=F(N.pos).map(W),N.drag=null;var t=_[0];if(t&&"move"===t.type){var r=t.unit,a=t.path;if(a&&a.length){var n=a[a.length-1],i=St(R,N.cell);!i&&It(N.cell,n)&&function(e,t){R.units.indexOf(e);B.ranges.length=0,B.src=e.cell,e.cell=t[t.length-1].slice(),_.unshift({type:"moving",unit:e,path:t,time:L.time}),T.dest=[-j(e.cell[0]),-j(e.cell[1])]}(r,a)}else if(D.selection.ghost){var l=D.selection.ghost;D.selection.ghost=null,D.selection.wrap.removeChild(l.el),D.shadows.wrap.removeChild(l.shadow)}}}),window.addEventListener("resize",function(e){T.size[0]=window.innerWidth/H,T.size[1]=window.innerHeight/H,console.log(T.size)}),window.addEventListener("contextmenu",function(e){return e.preventDefault(),!1})}(a,r.game),a}function z(e,t){var r=t.map,a=e.sprites,n=e.state,i=n.cursor,l=n.viewport,s=n.screens,o=n.modes,u=n.anims,c=n.cache,p=c.layers,f=++n.time,v=o[0];if(c.modes.length!==o.length){var h=c.modes[0];var d=o[0];c.modes=o.slice();if(h&&h.type==="move"){var g=p.selection.ghost;if(g){p.selection.ghost=null;p.selection.wrap.removeChild(g.el);p.shadows.wrap.removeChild(g.shadow)}var m=true;var w=false;var y=undefined;try{for(var x=p.squares.list[Symbol.iterator](),b;!(m=(b=x.next()).done);m=true){var k=b.value;p.squares.wrap.removeChild(k)}}catch(e){w=true;y=e}finally{try{if(!m&&x.return){x.return()}}finally{if(w){throw y}}}p.squares.list.length=0;var C=p.markers.cursor;if(C){p.markers.wrap.removeChild(C.el);p.markers.cursor=null}if(!d||d.type!=="moving"){var I=p.markers.arrow;if(I){p.markers.wrap.removeChild(I);p.markers.arrow=null}c.cursor.cell=null}var z=h.unit;var A=r.units.indexOf(z);var M=p.pieces.list[A];var S=z.cell[0]*16;var E=z.cell[1]*16-1;M.style.left=S+"px";M.style.top=E+"px"}if(h&&h.type==="act"){var O=r.units.indexOf(h.unit);var q=p.pieces.list[O];p.pieces.wrap.appendChild(q);p.ring.wrap.removeChild(h.ring);var L=true;var R=false;var N=undefined;try{for(var T=h.buttons[Symbol.iterator](),_;!(L=(_=T.next()).done);L=true){var B=_.value;p.buttons.wrap.removeChild(B.el)}}catch(e){R=true;N=e}finally{try{if(!L&&T.return){T.return()}}finally{if(R){throw N}}}c.src=null}if(d&&d.type==="move"){var D=d.unit;var P=r.units.indexOf(D);var F=p.pieces.list[P];p.selection.wrap.appendChild(F);var H=c.ranges[P];if(!H){H=c.ranges[P]=Mt(r,D)}var W=Array.prototype.concat(H.move,H.attack);var j=kt(W);var G=xt(j.width*16,j.height*16);var U=true;var X=false;var Y=undefined;try{for(var J=H.move[Symbol.iterator](),K;!(U=(K=J.next()).done);U=true){var Q=K.value;if(It(Q,D.cell))continue;var V=(Q[0]-j.left)*16;var Z=(Q[1]-j.top)*16;G.drawImage(a.ui.squares.move,V,Z)}}catch(e){X=true;Y=e}finally{try{if(!U&&J.return){J.return()}}finally{if(X){throw Y}}}var $=true;var ee=false;var te=undefined;try{for(var re=H.attack[Symbol.iterator](),ae;!($=(ae=re.next()).done);$=true){var ne=ae.value;if(zt(H.move,ne)!==-1)continue;var ie=(ne[0]-j.left)*16;var le=(ne[1]-j.top)*16;G.drawImage(a.ui.squares.attack,ie,le)}}catch(e){ee=true;te=e}finally{try{if(!$&&re.return){re.return()}}finally{if(ee){throw te}}}G.canvas.className="range";G.canvas.style.left=j.left*16+"px";G.canvas.style.top=j.top*16+"px";p.squares.wrap.appendChild(G.canvas);p.squares.list.push(G.canvas)}if(d&&d.type==="act"){var se=d.unit;var oe=d.options;for(var ue=0;ue<oe.length;ue++){var ce=oe[ue];var pe=null;if(ce==="attack")pe=a.icons.sword;if(ce==="wait")pe=a.icons.checkmark;if(ce==="back")pe=a.icons.arrow;var fe=a.ui.Button(pe);fe.style.display="none";var ve={id:ce,el:fe};p.buttons.wrap.appendChild(fe);d.buttons.push(ve)}var he=xt(48,48);var de=se.cell[0]*16-16;var ge=se.cell[1]*16-16;he.canvas.style.left=de+"px";he.canvas.style.top=ge+"px";d.ring=he.canvas;p.ring.wrap.appendChild(he.canvas)}}if(v&&v.unit){var me=v.unit;if(!c.box){var we=a.ui.Box(me.name.length*8+12+16,8+16);var ye=a.ui.Text(me.name);var xe=a.icons[bt[me.type]];var be=we.getContext("2d");be.drawImage(xe,8,8);be.drawImage(ye,20,8);we.className="box";var ke={pos:[-we.width,l.size[1]-we.height-8],element:we,exiting:false};p.boxes.wrap.appendChild(ke.element);p.boxes.list.push(ke.element);c.box=ke}}else if(c.box){c.box.exiting=true}if(v){if(v.type==="move"||v.type==="act"){var Ce=v.unit;var Ie=r.units.indexOf(Ce);var ze=p.pieces.list[Ie];var Ae=f-v.time;if(Ae>7){var Me=(Ae-7)%120/120;Ae=Math.round(7+Math.sin(2*Math.PI*Me)*2)}ze.style.left=Ce.cell[0]*16+"px";ze.style.top=Ce.cell[1]*16-Ae+"px"}if(v.type==="move"){var Se=v.unit;var Ee=r.units.indexOf(Se);var Oe=p.pieces.list[Ee];if(i.drag&&v.type==="move"){if(!p.selection.ghost){var qe=yt(Oe);qe.className="ghost piece";qe.style.display="none";var Le=yt(a.pieces.shadow);Le.className="ghost shadow";p.shadows.wrap.appendChild(Le);p.selection.wrap.appendChild(qe);p.selection.ghost={el:qe,shadow:Le}}var Re=i.drag[0]+i.pos[0]-l.pos[0];var Ne=i.drag[1]+i.pos[1]-l.pos[1];var Te=p.selection.ghost.el;var _e=p.selection.ghost.shadow;if(!It(i.cell,Se.cell)){Te.style.left=Re+"px";Te.style.top=Ne-12+"px";Te.style.display="block";_e.style.left=Re+1+"px";_e.style.top=Ne+4+"px";_e.style.display="block"}else{Te.style.display="none";_e.style.display="none"}}}else if(v.type==="moving"){var Be=v.unit;var De=v.path;var Pe=f-v.time;var Fe=Pe/De.length/2;var He=Et(De,Fe);var We=He[0]*16;var je=He[1]*16;var Ge=r.units.indexOf(Be);var Ue=p.pieces.list[Ge];Ue.style.left=We+"px";Ue.style.top=je-1+"px";var Xe=p.shadows.list[Ge];Xe.style.left=We+1+"px";Xe.style.top=je+3+"px";var Ye=p.markers.arrow;if(Ye){if(Pe%2===0){Ye.style.display="none"}else{Ye.style.display="block"}}if(Fe===1){p.markers.wrap.removeChild(Ye);p.markers.arrow=null;var Je=["wait","back"];var Ke=At(Be.cell,Ct(Be.type));var Qe=Ke.filter(function(e){return St(r,e)});var Ve=Qe.map(function(e){return St(r,e)});var Ze=Ve.filter(function(e){return e.faction!==Be.faction});if(Ze.length){Je.unshift("attack")}o.unshift({type:"act",unit:Be,time:f,options:Je,buttons:[]})}}else if(v.type==="act"){var $e=f-v.time;var et=($e-5)/30;if(et<0)et=0;if(et>1)et=1;var tt=-Math.pow(2,-10*et)+1;var rt=v.unit;var at=v.options;var nt=2*Math.PI/at.length;for(var it=0;it<at.length;it++){var lt=at[it];var st=p.buttons.wrap.children[it];var ot=nt*it+Math.PI/2+Math.PI*tt;var ut=20*tt;var ct=rt.cell[0]*16+Math.cos(ot)*ut;var pt=rt.cell[1]*16+Math.sin(ot)*ut;if(tt){st.style.display="block"}st.style.left=ct+"px";st.style.top=pt+"px"}var ft=Math.floor($e/3);if(ft<a.ui.ring.length){var vt=a.ui.ring[ft];var ht=v.ring;var dt=ht.getContext("2d");dt.clearRect(0,0,ht.width,ht.height);dt.drawImage(vt,0,0)}}}if(c.box){var gt=c.box;qt(gt);if(gt.pos[0]<-gt.element.width-16*15){p.boxes.wrap.removeChild(gt.element);p.boxes.list.splice(p.boxes.list.indexOf(gt.element),1);c.box=null}}if(Lt(e,t),v&&"move"===v.type){Ot(e,t)}if(i.drag&&!v){var mt=i.drag[0]+i.pos[0];var wt=i.drag[1]+i.pos[1];l.pos[0]=mt;l.pos[1]=wt}}function Ot(e,t){var r=e.state,a=r.modes[0],n=a.unit,i=r.cursor,l=t.map,s=l.units.indexOf(n),o=e.sprites,u=r.cache,c=u.ranges[s],p=u.layers;if(p.markers.cursor&&a.path&&a.path.length){var f=a.path;var v=f[f.length-1];var h=v[0]*16;var d=v[1]*16;var g=p.markers.cursor,m=g.el,w=g.pos;w[0]+=(h-w[0])/4;w[1]+=(d-w[1])/4;m.style.left=w[0]+"px";m.style.top=w[1]+"px"}if(u.cursor.cell&&It(u.cursor.cell,i.cell)){return}u.cursor.cell=i.cell;var y=a.path=L(l,n,i.cell,c,a.path);if(y.length){if(y.length>1){var x=kt(y);var b=o.ui.Arrow(y);var k=p.markers.arrow;if(!k){k=b;k.className="arrow";p.markers.arrow=k;p.markers.wrap.appendChild(k)}else{var C=k.getContext("2d");k.width=b.width;k.height=b.height;C.drawImage(b,0,0)}k.style.left=x.left*16+"px";k.style.top=x.top*16+"px"}else if(y.length===1){var I=p.markers.arrow;if(I){p.markers.arrow=null;p.markers.wrap.removeChild(I)}}var z=y[y.length-1];var A=z[0]*16;var M=z[1]*16;if(!p.markers.cursor){var S=yt(o.ui.cursor[0]);var E=[A,M];S.className="cursor";S.style.left=A+"px";S.style.top=M+"px";p.markers.wrap.appendChild(S);p.markers.cursor={el:S,pos:E}}}else{a.path=null;u.cursor.cell=null;var O=p.markers.cursor;if(O){p.markers.cursor=null;p.markers.wrap.removeChild(O.el)}var q=p.markers.arrow;if(q){p.markers.arrow=null;p.markers.wrap.removeChild(q)}}}function qt(e){if(!e.exiting){e.pos[0]+=(8-e.pos[0])/4}else{e.pos[0]-=24}var t=e.element;t.style.left=Math.round(e.pos[0])+"px",t.style.top=Math.round(e.pos[1])+"px"}function Lt(e,t){var r=e.state.viewport,a=e.state.cache.layers,n=[16*t.map.layout.size[0]-r.size[0],16*t.map.layout.size[1]-r.size[1]];if(r.dest&&(r.pos[0]+=(r.dest[0]-r.pos[0])/8,r.pos[1]+=(r.dest[1]-r.pos[1])/8),0<=n[0]&&0<=n[1]){var i=r.dest||r.pos;i[0]>-r.size[0]/2?i[0]=-r.size[0]/2:i[0]+r.size[0]/2<-n[0]&&(i[0]=-n[0]-r.size[0]/2),i[1]>-r.size[1]/2?i[1]=-r.size[1]/2:i[1]+r.size[1]/2<-n[1]&&(i[1]=-n[1]-r.size[1]/2)}var l=Math.round(r.pos[0]),s=Math.round(r.pos[1]);a.game.style.transform="translate("+l+"px, "+s+"px)"}function A(e){return{wrap:m("layer "+e),list:[]}}function W(e){return Math.floor(e/16)}function j(e){return 16*e+8}(C="sprites.png",new Promise(function(e,t){var r=new Image;r.src=C,r.onload=function(){e(r)},r.onerror=function(){t(new Error("Failed to load image `"+C+"`"))}})).then(function(e){var t=i(e),r=I({state:O,actions:q},t);document.body.appendChild(r.element)});var M,S,E,O={game:(S=(M=e).units.map(function(e){return function(e,t,r,a,n){return{name:e,type:t,faction:r,ai:a,cell:n,hp:3}}.apply(void 0,_toConsumableArray(e))}),E=S.filter(function(e){return"player"===e.faction}),{map:{layout:M.map,units:S},phase:{faction:"player",pending:E}})},q={game:{move:function(e,t,r){var a;a=r,t.cell=a.slice()},attack:function(e,t,r){}}}}();