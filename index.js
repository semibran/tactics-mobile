"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],a=!0,n=!1,l=void 0;try{for(var i,s=e[Symbol.iterator]();!(a=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);a=!0);}catch(e){n=!0,l=e}finally{try{!a&&s.return&&s.return()}finally{if(n)throw l}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(){var a={piece:{shadow:[402,524,14,14],base:[560,0,16,16]},tiles:{grass:[320,540,16,16]},effects:{shockwave:[80,512,160,24],attack:[320,512,192,12]},ui:{cursor:[512,512,32,16],box:[512,0,48,48],squares:[512,48,32,16],arrows:[256,512,64,64],healthbar:[175,536,48,8],words:{player:[80,536,95,16],phase:[80,552,80,16],enemy:[320,524,82,16]},typeface:[0,512,80,64],circle:[240,512,16,16]},maps:{test:[256,0,256,512],"test-tree":[0,0,256,512]},icons:{target:[80,568,8,8],cursor:[160,552,8,8],checkmark:[512,64,8,8],wing:[544,48,8,8],dragon:[512,528,8,8],viking:[544,512,8,8],shield:[175,544,8,8],bow:[560,24,8,8],fuse:[240,528,8,8],element:[560,16,8,8],book:[320,556,8,8],boot:[336,540,8,8],puzzle:[402,538,8,8],"axe-2":[416,524,8,8],ice:[88,568,8,8],fire:[160,560,8,8],muscle:[168,552,8,8],dagger:[512,72,8,8],sword:[520,64,8,8],arrow:[544,56,8,8],sabre:[552,48,8,8],helmet:[512,536,8,8],thunder:[520,528,8,8],next:[544,520,8,8],eye:[552,512,8,8],clock:[183,544,8,8],axe:[223,544,8,8],"hat-2":[231,536,8,8],hat:[240,536,8,8],enemy:[248,528,8,8],lance:[223,536,8,8]}},ct=function(e,t,r,a,n){t||(t=0),r||(r=0),a||(a=e.width),n||(n=e.height);var l=document.createElement("canvas"),i=l.getContext("2d");return l.width=a,l.height=n,i.drawImage(e,-t,-r),l};function pt(e,t){var r=document.createElement("canvas"),a=r.getContext("2d");return r.width=e,r.height=t,a}var c={get:function(e,t,r){var a=4*(r*e.width+t),n=e.data[a],l=e.data[a+1],i=e.data[a+2],s=e.data[a+3];return[n,l,i,s]},set:function(e,t,r,a){var n=4*(r*e.width+t);e.data[n+0]=a[0],e.data[n+1]=a[1],e.data[n+2]=a[2],e.data[n+3]=a[3]},replace:function(e,t,r){for(var a=0;a<e.data.length;a+=4){for(var n=0;n<4&&e.data[a+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[a+n]=r[n]}}},h={black:[0,0,0,255],gray:[168,168,168,255],white:[255,255,255,255],cyan:[144,224,232,255],blue:[80,120,248,255],navy:[88,24,216,255],pink:[248,192,224,255],red:[208,0,88,255],purple:[56,0,80,255],lime:[200,224,144,255],green:[40,192,32,255],teal:[0,96,112,255],yellow:[232,224,56,255]},ft={fighter:"axe",knight:"shield",thief:"dagger",mage:"hat",berserker:"viking",general:"helmet",assassin:"sabre",sorcerer:"hat-2"};function o(e,t,r){e=e.getContext("2d").getImageData(0,0,16,16),t=t.getContext("2d").getImageData(0,0,t.width,t.height),c.replace(e,h.white,r.default),c.replace(e,h.black,r.dark);var a=pt(e.width,e.height);a.putImageData(e,0,0);var n=pt(8,8);c.replace(t,h.white,r.light),n.putImageData(t,0,0),a.drawImage(n.canvas,4,4);var l,i,s,o,u=pt(8,8);return c.replace(t,r.light,r.dark),u.putImageData(t,0,0),a.drawImage(u.canvas,4,3),l=a.canvas,i=4,s=document.createElement("canvas"),o=s.getContext("2d"),s.width=l.width*i,s.height=l.height*i,o.webkitImageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,o.msImageSmoothingEnabled=!1,o.imageSmoothingEnabled=!1,o.drawImage(l,0,0,l.width*i,l.height*i),s}function ht(e){for(var t=1/0,r=1/0,a=-1/0,n=-1/0,l=0;l<e.length;l++){var i=e[l],s=i[0],o=i[1];s<t&&(t=s),a<s&&(a=s),o<r&&(r=o),n<o&&(n=o)}return{left:t,top:r,right:a,bottom:n,width:a-t+1,height:n-r+1}}var v=function(e,t,r,a,n){var l=document.createElement("canvas"),i=l.getContext("2d");return l.width=a,l.height=n,i.drawImage(e,-t,-r),l};function n(e){var t,a,r,O,n,s,l,i,o=(t=e.ui.cursor,[v(t,0,0,16,16),v(t,16,0,16,16)]),u=(a=e.ui.circle,function(e){var t=ct(a),r=t.getContext("2d");return t.className="button",r.drawImage(e,4,4),t}),c=(r=e.ui.arrows,O={left:v(r,0,0,16,16),right:v(r,16,0,16,16),up:v(r,32,0,16,16),down:v(r,48,0,16,16),leftStub:v(r,0,16,16,16),rightStub:v(r,16,16,16,16),upStub:v(r,32,16,16,16),downStub:v(r,48,16,16,16),upLeft:v(r,0,32,16,16),upRight:v(r,16,32,16,16),downLeft:v(r,32,32,16,16),downRight:v(r,48,32,16,16),horiz:v(r,0,48,16,16),vert:v(r,16,48,16,16)},function(e){for(var t=[],r=0;r<e.length;r++){var a=_slicedToArray(e[r],2),n=a[0],l=a[1],i=!1,s=!1,o=!1,u=!1,c=e[r-1];if(c){var p=n-c[0],f=l-c[1];1===p?i=!0:-1===p&&(s=!0),1===f?o=!0:-1===f&&(u=!0)}var h=e[r+1];if(h){var v=h[0]-n,d=h[1]-l;-1===v?i=!0:1===v&&(s=!0),-1===d?o=!0:1===d&&(u=!0)}if(i||s||o||u){var m=null;i&&s?m="horiz":o&&u?m="vert":o&&i?m="upLeft":o&&s?m="upRight":u&&i?m="downLeft":u&&s?m="downRight":i&&!r?m="leftStub":s&&!r?m="rightStub":o&&!r?m="upStub":u&&!r?m="downStub":i?m="left":s?m="right":o?m="up":u&&(m="down"),m&&t.push({sprite:O[m],position:[n,l]})}}var g=ht(e),y=pt(16*g.width,16*g.height),w=!0,x=!1,b=void 0;try{for(var k,C=t[Symbol.iterator]();!(w=(k=C.next()).done);w=!0){var I=k.value,z=I.sprite,A=I.position,S=_slicedToArray(A,2),M=S[0],E=S[1];y.drawImage(z,16*(M-g.left),16*(E-g.top))}}catch(e){x=!0,b=e}finally{try{!w&&C.return&&C.return()}finally{if(x)throw b}}return y.canvas}),p=function(e){for(var t=e.width/8,r=e.height/8,o={},a=0,n=0;n<r;n++)for(var l=0;l<t;l++){var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/-+     "[a++];o[i]=v(e,8*l,8*n,8,8)}return function(e){for(var t=0,r=0;r<e.length;r++)" "===e[r]?t+=4:t+=8;for(var a=pt(t,8),n=0,l=0;n<e.length;n++){var i=e[n];if(" "===i)l+=4;else{var s=o[i];a.drawImage(s,l,0),l+=8}}return a.canvas}}(e.ui.typeface),f=(n=e.ui.box,s={topLeft:v(n,0,0,16,16),top:v(n,16,0,16,16),topRight:v(n,32,0,16,16),left:v(n,0,16,16,16),center:v(n,16,16,16,16),right:v(n,32,16,16,16),bottomLeft:v(n,0,32,16,16),bottom:v(n,16,32,16,16),bottomRight:v(n,32,32,16,16)},function(e,t){for(var r=Math.ceil(e/16),a=Math.ceil(t/16),n=pt(e,t),l=1;l<r-1;l++)n.drawImage(s.top,16*l,0),n.drawImage(s.bottom,16*l,t-16);for(var i=1;i<a-1;i++)n.drawImage(s.left,0,16*i),n.drawImage(s.right,e-16,16*i);return n.fillRect(4,4,e-8,t-8),n.drawImage(s.topLeft,0,0),n.drawImage(s.topRight,e-16,0),n.drawImage(s.bottomLeft,0,t-16),n.drawImage(s.bottomRight,e-16,t-16),n.canvas});return{Text:p,Box:f,TextBox:(l=p,i=f,function(e){var t=l(e),r=t.width,a=i(r+16,24),n=pt(r,8);return n.drawImage(t,0,0),n.canvas.width&&a.getContext("2d").drawImage(n.canvas,8,8),a}),Arrow:c,Button:u,squares:function(){return{move:e(h.blue),attack:e(h.red),fuse:e(h.yellow)};function e(e){var t=pt(16,16);return t.fillStyle=function(e,t,r,a){return"rgba("+e+", "+t+", "+r+", "+a+")"}.apply(void 0,_toConsumableArray(e)),t.globalAlpha=.5,t.fillRect(0,0,15,15),t.canvas}}(),cursor:o}}function l(e){var t=function e(t,r){var a={};for(var n in r)if(Array.isArray(r[n])){var l=_slicedToArray(r[n],4),i=l[0],s=l[1],o=l[2],u=l[3];a[n]=ct(t,i,s,o,u)}else a[n]=e(t,r[n]);return a}(e,a),r=function(e){var t={},r={player:{default:h.blue,light:h.cyan,dark:h.navy},enemy:{default:h.red,light:h.pink,dark:h.purple}};for(var a in r){var n=r[a];for(var l in ft){var i=ft[l],s=e.icons[i];t[l]||(t[l]={}),t[l][a]=o(e.piece.base,s,n)}}return t}(t);return{Piece:function(e,t){return ct(r[e][t])},pieces:{shadow:t.piece.shadow},ui:n(t),effects:t.effects,tiles:t.tiles,icons:t.icons}}var t={name:"grass",walkable:!0},e={id:"test",map:{size:[12,16],data:"                                                                                                                                                                                                ".split("").map(function(e){switch(e){case" ":return t}})},units:[["Ulysses","knight","player",null,[4,6]],["Alice","mage","player",null,[3,9]],["Garrick","fighter","enemy",null,[8,7]]]};function g(e){var t=document.createElement("div");return t.className=e,t}var r={axe:{type:"axe",stat:"str",atk:2,hit:0,rng:1},lance:{type:"lance",stat:"str",atk:2,hit:1,rng:1},dagger:{type:"dagger",stat:"str",atk:1,hit:1,rng:1},tome:{type:"tome",stat:"int",atk:2,hit:1,rng:2}},i={leather:{def:1,wt:0},mail:{def:2,wt:1},plate:{def:3,wt:1}};function y(e,t){return e.faction===t.faction}function w(e){var t=u[e].armor,r=t?t.wt:0;return 5+Math.floor(s[e].agi/3-r/2)}function vt(e){return(t=e,u[t].weapon).rng;var t}var s={fighter:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:1},thief:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},u={fighter:{weapon:r.axe,armor:i.leather},knight:{weapon:r.lance,armor:i.mail},thief:{weapon:r.dagger,armor:i.leather},mage:{weapon:r.tome,armor:i.leather},berserker:{weapon:r.axe,armor:i.leather},general:{weapon:r.lance,armor:i.plate},assassin:{weapon:r.dagger,armor:i.leather},sorcerer:{weapon:r.tome,armor:i.leather}};function x(e,t){return Math.abs(p(t)-p(e))+Math.abs(f(t)-f(e))}function p(e){return e[0]}function f(e){return e[1]}function dt(e,t){return p(e)===p(t)&&f(e)===f(t)}function mt(e,t){for(var r=0;r<e.length;r++)if(dt(e[r],t))return r;return-1}function gt(e,t){t||(t=1);for(var r=[{steps:0,cell:e}],a=[];r.length;)for(var n=r.shift(),l=[[p(n.cell)-1,f(n.cell)],[p(n.cell)+1,f(n.cell)],[p(n.cell),f(n.cell)-1],[p(n.cell),f(n.cell)+1]],i=0;i<l.length;i++){var s=l[i];dt(e,s)||-1!==mt(a,s)||(a.push(s),n.steps+1<t&&r.push({steps:n.steps+1,cell:s}))}return a}function yt(e,t){var r={move:[t.cell],attack:[],fuse:[]},a="defend"===t.ai?0:w(t.type),n=[{steps:0,cell:t.cell}],l=[];for(a||(n.length=0,l.push(t.cell));n.length;)for(var i=n.shift(),s=gt(i.cell),o=0;o<s.length;o++){if(b(e,p=s[o])&&-1===mt(r.move,p)){if(f=wt(e,p)){var u=y(t,f)?r.fuse:r.attack;f.type!==t.type&&u===r.fuse||-1===mt(u,p)&&u.push(p)}else r.move.push(p);i.steps<a-1?f&&!y(t,f)||n.push({steps:i.steps+1,cell:p}):l.push(p)}}for(o=0;o<l.length;o++){s=gt(l[o],vt(t.type));for(var c=0;c<s.length;c++){var p,f;if(m(e,p=s[c])&&b(e,p)&&!dt(t.cell,p))(f=wt(e,p))&&y(t,f)||-1===mt(r.attack,p)&&r.attack.push(p),(!f||y(t,f)&&t.type===f.type)&&-1===mt(r.fuse,p)&&r.fuse.push(p)}}return r}function d(e){return e.layout.size[0]}function m(e,t){return 0<=p(t)&&p(t)<d(e)&&0<=f(t)&&f(t)<e.layout.size[1]}function wt(e,t){for(var r=0;r<e.units.length;r++){var a=e.units[r];if(dt(a.cell,t))return a}}function b(e,t){return m(e,t)&&(r=e,a=t,r.layout.data[f(a)*d(r)+p(a)]).walkable;var r,a}function k(e,t,r){for(var a=[],n=[t],l={},i={},s={},o={},u={},c=0;c<e.length;c++){var p=e[c];o[p]=1/0,u[p]=1/0}for(o[t]=0,u[t]=x(t,r);n.length;){var f={score:1/0,index:-1,cell:null};for(c=0;c<n.length;c++){(d=u[h=n[c]])<f.score&&(f.score=d,f.index=c,f.cell=h)}var h;if(dt(h=f.cell,r)){for(;!dt(h,t);)a.unshift(h),h=s[h];return a.unshift(h),a}n.splice(f.index,1),l[h]=!1,i[h]=!0;var v=gt(h);for(c=0;c<v.length;c++){var d,m=v[c];if(-1!==mt(e,m))if(!i[m])l[m]||(l[m]=!0,n.push(m)),(d=o[h]+1)>=o[m]||(s[m]=h,o[m]=d,u[m]=d+x(m,r))}}return[]}function L(e,r,t,a,n){if(dt(t,r.cell))return[t];var l=a.move.slice(),i=!0,s=!1,o=void 0;try{for(var u,c=e.units[Symbol.iterator]();!(i=(u=c.next()).done);i=!0){var p=u.value;y(r,p)&&!dt(r.cell,p.cell)&&(x(r.cell,p.cell)>w(r.type)||l.push(p.cell))}}catch(e){s=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(s)throw o}}var f=t,h=wt(e,t);if(h){var v=y(r,h)?gt(h.cell):gt(h.cell,vt(r.type));if(n){var d=v.filter(function(e){return-1!==mt(n,e)});d.length&&(f=d.sort(function(e,t){return n.indexOf(e)-n.indexOf(t)})[0])}if(!f)f=v.filter(function(e){return-1!==mt(l,e)}).sort(function(e,t){return x(r.cell,e)-x(r.cell,t)})[0]}if(!n)return k(l,r.cell,f);if(dt(f,n[n.length-1]))return n;var m=mt(n,f);if(-1!==m)return n.slice(0,m+1);var g=k(l.filter(function(e){return-1===mt(n,e)}),n[n.length-1],f);return g.length?g&&n.length+g.length-2<=w(r.type)?(g.shift(),[].concat(_toConsumableArray(n),_toConsumableArray(g))):k(l,r.cell,f):[]}function xt(e,t){var r=t*(e.length-1),a=Math.floor(r),n=r-a;if(1===t)return e[a];var l=e[a],i=e[a+1];return[l[0]+(i[0]-l[0])*n,l[1]+(i[1]-l[1])*n]}var C,H=2;function I(e,t){var r=e.state,a=(e.actions,{sprites:t,element:document.createElement("main"),state:{time:0,cursor:{pos:null,drag:null},viewport:{size:[window.innerWidth/H,window.innerHeight/H],pos:[0,0],dest:null},modes:[],anims:[],cache:{box:null,layers:{},ranges:[],modes:[],units:[],cursor:{cell:null,unit:null}}}});return function(t,r,e){var L=t.state,R=r.map,a=t.sprites,N=L.cursor,T=L.viewport,_=L.modes,B=(L.anims,L.cache),D=B.layers;D.game=g("game"),D.map=function(e,t){var r=16*t.layout.size[0],a=16*t.layout.size[1],n=pt(r,a);n.canvas.className="map";for(var l=0;l<t.layout.size[1];l++)for(var i=0;i<t.layout.size[0];i++)n.drawImage(e.tiles.grass,16*i,16*l);return n.canvas}(a,R),D.ui=g("ui");var n=R.units[0];if(n){var l=-j(n.cell[0]),i=-j(n.cell[1]);T.pos=[l,i],Ct(t,r)}D.shadows=A("shadows"),D.squares=A("squares"),D.boxes=A("boxes"),D.buttons=A("buttons"),D.markers={wrap:g("layer markers"),arrow:null,cursor:null},D.pieces={wrap:g("layer pieces"),list:[],selection:{z:0}},D.selection={wrap:g("layer selection"),piece:null,z:0};var s=!0,o=!1,u=void 0;try{for(var c,p=R.units[Symbol.iterator]();!(s=(c=p.next()).done);s=!0){var f=c.value,h=16*f.cell[0],v=16*f.cell[1],d=a.Piece(f.type,f.faction);d.className="piece",d.style.left=h+"px",d.style.top=v-1+"px",D.pieces.wrap.appendChild(d),D.pieces.list.push(d);var m=ct(a.pieces.shadow);m.className="shadow",m.style.left=h+1+"px",m.style.top=v+3+"px",D.shadows.wrap.appendChild(m),D.shadows.list.push(m)}}catch(e){o=!0,u=e}finally{try{!s&&p.return&&p.return()}finally{if(o)throw u}}function P(e){var t=e.touches[0]||e.changedTouches[0];return[t.pageX/H,t.pageY/H]}function F(e){var t=D.game.getBoundingClientRect();return[e[0]-t.left/H,e[1]-t.top/H]}D.game.appendChild(D.map),D.game.appendChild(D.squares.wrap),D.game.appendChild(D.shadows.wrap),D.game.appendChild(D.pieces.wrap),D.game.appendChild(D.markers.wrap),D.game.appendChild(D.buttons.wrap),D.game.appendChild(D.selection.wrap),D.ui.appendChild(D.boxes.wrap),t.element.appendChild(D.game),t.element.appendChild(D.ui),function e(){z(t,r);requestAnimationFrame(e)}(),t.element.addEventListener("touchstart",function(e){var t=N.pos=P(e),r=N.cell=F(N.pos).map(W),a=wt(R,r),n=R.units.indexOf(a),l=D.pieces.list[n],i=_[0];if(i){if(i&&"move"===i.type)if(a)a!==i.unit&&(_.length=0,D.pieces.wrap.appendChild(l),T.dest=null);else{var s=i.unit,o=R.units.indexOf(s),u=B.ranges[o];D.pieces.list[o];-1===mt(u.move,r)?_.shift():N.drag=[16*r[0]-t[0]+T.pos[0],16*r[1]-t[1]+T.pos[1]]}else if(i&&"act"===i.type){var c=null,p=!0,f=!1,h=void 0;try{for(var v,d=i.buttons[Symbol.iterator]();!(p=(v=d.next()).done);p=!0){var m=v.value,g=m.el.getBoundingClientRect(),y=g.width/2,w=g.left+y,x=g.top+y,b=Math.pow(w-N.pos[0]*H,2),k=Math.pow(x-N.pos[1]*H,2);if(b+k<y*y){c=m;break}}}catch(e){f=!0,h=e}finally{try{!p&&d.return&&d.return()}finally{if(f)throw h}}if(!c||"back"===c.id){var C=i.unit;C.cell=B.src;var I=R.units.indexOf(C),z=D.selection.wrap.children[0],A=D.shadows.wrap.children[I],S=16*C.cell[0],M=16*C.cell[1];z.style.left=S+"px",z.style.top=M-1+"px",A.style.left=S+1+"px",A.style.top=M+4+"px",T.dest=[-j(C.cell[0]),-j(C.cell[1])]}_.length=0}}else if(a){var E=B.ranges[n];E||(E=B.ranges[n]=yt(R,a)),_.push({type:"move",unit:a,path:[r],range:E,time:L.time});var O=-j(a.cell[0]),q=-j(a.cell[1]);T.dest=[O,q],N.drag=[parseInt(l.style.left)-t[0]+T.pos[0],parseInt(l.style.top)-t[1]+T.pos[1]]}else T.dest=null,N.drag=[T.pos[0]-t[0],T.pos[1]-t[1]]}),t.element.addEventListener("touchmove",function(e){e.preventDefault(),N.pos=P(e),N.cell=F(N.pos).map(W)}),t.element.addEventListener("touchend",function(e){N.pos=P(e),N.cell=F(N.pos).map(W),N.drag=null;var t=_[0];if(t&&"move"===t.type){var r=t.unit,a=t.path;if(a&&a.length){var n=a[a.length-1],l=wt(R,N.cell);!l&&dt(N.cell,n)&&function(e,t){R.units.indexOf(e);B.ranges.length=0,B.src=e.cell,e.cell=t[t.length-1].slice(),_.unshift({type:"moving",unit:e,path:t,time:L.time}),T.dest=[-j(e.cell[0]),-j(e.cell[1])]}(r,a)}else if(D.selection.ghost){var i=D.selection.ghost;D.selection.ghost=null,D.selection.wrap.removeChild(i.el),D.shadows.wrap.removeChild(i.shadow)}}}),window.addEventListener("resize",function(e){T.size[0]=window.innerWidth/H,T.size[1]=window.innerHeight/H,console.log(T.size)}),window.addEventListener("contextmenu",function(e){return e.preventDefault(),!1})}(a,r.game),a}function z(e,t){var r=t.map,a=e.sprites,n=e.state,l=n.cursor,i=n.viewport,s=n.screens,o=n.modes,u=n.anims,c=n.cache,p=c.layers,f=++n.time,h=o[0];if(c.modes.length!==o.length){var v=c.modes[0];var d=o[0];c.modes=o.slice();if(v&&v.type==="move"){var m=p.selection.ghost;if(m){p.selection.ghost=null;p.selection.wrap.removeChild(m.el);p.shadows.wrap.removeChild(m.shadow)}var g=true;var y=false;var w=undefined;try{for(var x=p.squares.list[Symbol.iterator](),b;!(g=(b=x.next()).done);g=true){var k=b.value;p.squares.wrap.removeChild(k)}}catch(e){y=true;w=e}finally{try{if(!g&&x.return){x.return()}}finally{if(y){throw w}}}p.squares.list.length=0;var C=p.markers.cursor;if(C){p.markers.wrap.removeChild(C.el);p.markers.cursor=null}if(!d||d.type!=="moving"){var I=p.markers.arrow;if(I){p.markers.wrap.removeChild(I);p.markers.arrow=null}c.cursor.cell=null}var z=v.unit;var A=r.units.indexOf(z);var S=p.pieces.list[A];var M=z.cell[0]*16;var E=z.cell[1]*16-1;S.style.left=M+"px";S.style.top=E+"px"}if(v&&v.type==="act"){var O=r.units.indexOf(v.unit);var q=p.pieces.list[O];p.pieces.wrap.appendChild(q);c.src=null;var L=true;var R=false;var N=undefined;try{for(var T=v.buttons[Symbol.iterator](),_;!(L=(_=T.next()).done);L=true){var B=_.value;p.buttons.wrap.removeChild(B.el)}}catch(e){R=true;N=e}finally{try{if(!L&&T.return){T.return()}}finally{if(R){throw N}}}}if(d&&d.type==="move"){var D=d.unit;var P=r.units.indexOf(D);var F=p.pieces.list[P];p.selection.wrap.appendChild(F);var H=c.ranges[P];if(!H){H=c.ranges[P]=yt(r,D)}var W=Array.prototype.concat(H.move,H.attack);var j=ht(W);var G=pt(j.width*16,j.height*16);var U=true;var X=false;var Y=undefined;try{for(var J=H.move[Symbol.iterator](),K;!(U=(K=J.next()).done);U=true){var Q=K.value;if(dt(Q,D.cell))continue;var V=(Q[0]-j.left)*16;var Z=(Q[1]-j.top)*16;G.drawImage(a.ui.squares.move,V,Z)}}catch(e){X=true;Y=e}finally{try{if(!U&&J.return){J.return()}}finally{if(X){throw Y}}}var $=true;var ee=false;var te=undefined;try{for(var re=H.attack[Symbol.iterator](),ae;!($=(ae=re.next()).done);$=true){var ne=ae.value;if(mt(H.move,ne)!==-1)continue;var le=(ne[0]-j.left)*16;var ie=(ne[1]-j.top)*16;G.drawImage(a.ui.squares.attack,le,ie)}}catch(e){ee=true;te=e}finally{try{if(!$&&re.return){re.return()}}finally{if(ee){throw te}}}G.canvas.className="range";G.canvas.style.left=j.left*16+"px";G.canvas.style.top=j.top*16+"px";p.squares.wrap.appendChild(G.canvas);p.squares.list.push(G.canvas)}if(d&&d.type==="act"){var se=d.unit;var oe=d.options;for(var ue=0;ue<oe.length;ue++){var ce=oe[ue];var pe=null;if(ce==="attack")pe=a.icons.sword;if(ce==="wait")pe=a.icons.checkmark;if(ce==="back")pe=a.icons.arrow;var fe=a.ui.Button(pe);fe.style.display="none";var he={id:ce,el:fe};p.buttons.wrap.appendChild(fe);d.buttons.push(he)}}}if(h&&h.unit){var ve=h.unit;if(!c.box){var de=a.ui.Box(ve.name.length*8+12+16,8+16);var me=a.ui.Text(ve.name);var ge=a.icons[ft[ve.type]];var ye=de.getContext("2d");ye.drawImage(ge,8,8);ye.drawImage(me,20,8);de.className="box";var we={pos:[-de.width,i.size[1]-de.height-8],element:de,exiting:false};p.boxes.wrap.appendChild(we.element);p.boxes.list.push(we.element);c.box=we}}else if(c.box){c.box.exiting=true}if(h){if(h.type==="move"){var xe=h.unit;var be=r.units.indexOf(xe);var ke=p.pieces.list[be];var Ce=f-h.time;if(Ce>6){var Ie=(Ce-6)%120/120;Ce=Math.round(6+Math.sin(2*Math.PI*Ie)*2)}ke.style.left=xe.cell[0]*16+"px";ke.style.top=xe.cell[1]*16-Ce+"px";if(l.drag&&h.type==="move"){if(!p.selection.ghost){var ze=p.pieces.list[be];var Ae=ct(ze);Ae.className="ghost piece";Ae.style.display="none";var Se=ct(a.pieces.shadow);Se.className="ghost shadow";p.shadows.wrap.appendChild(Se);p.selection.wrap.appendChild(Ae);p.selection.ghost={el:Ae,shadow:Se}}var Me=l.drag[0]+l.pos[0]-i.pos[0];var Ee=l.drag[1]+l.pos[1]-i.pos[1];var Oe=p.selection.ghost.el;var qe=p.selection.ghost.shadow;if(!dt(l.cell,xe.cell)){Oe.style.left=Me+"px";Oe.style.top=Ee-12+"px";Oe.style.display="block";qe.style.left=Me+1+"px";qe.style.top=Ee+4+"px";qe.style.display="block"}else{Oe.style.display="none";qe.style.display="none"}}}else if(h.type==="moving"){var Le=h.unit;var Re=h.path;var Ne=f-h.time;var Te=Ne/Re.length/2;var _e=xt(Re,Te);var Be=_e[0]*16;var De=_e[1]*16;var Pe=r.units.indexOf(Le);var Fe=p.pieces.list[Pe];Fe.style.left=Be+"px";Fe.style.top=De-1+"px";var He=p.shadows.list[Pe];He.style.left=Be+1+"px";He.style.top=De+3+"px";var We=p.markers.arrow;if(We){if(Ne%2===0){We.style.display="none"}else{We.style.display="block"}}if(Te===1){p.markers.wrap.removeChild(We);p.markers.arrow=null;var je=["wait","back"];var Ge=gt(Le.cell,vt(Le.type));var Ue=Ge.filter(function(e){return wt(r,e)});var Xe=Ue.map(function(e){return wt(r,e)});var Ye=Xe.filter(function(e){return e.faction!==Le.faction});if(Ye.length){je.unshift("attack")}o.unshift({type:"act",unit:Le,time:f,options:je,buttons:[]})}}else if(h.type==="act"){var Je=f-h.time;var Ke=(Je-5)/30;if(Ke<0)Ke=0;if(Ke>1)Ke=1;var Qe=-Math.pow(2,-10*Ke)+1;var Ve=h.unit;var Ze=h.options;var $e=2*Math.PI/Ze.length;for(var et=0;et<Ze.length;et++){var tt=Ze[et];var rt=p.buttons.wrap.children[et];var at=$e*et+Math.PI/2+Math.PI*Qe;var nt=20*Qe;var lt=Ve.cell[0]*16+Math.cos(at)*nt;var it=Ve.cell[1]*16+Math.sin(at)*nt;if(Qe){rt.style.display="block"}rt.style.left=lt+"px";rt.style.top=it+"px"}}}if(c.box){var st=c.box;kt(st);if(st.pos[0]<-st.element.width-16*15){p.boxes.wrap.removeChild(st.element);p.boxes.list.splice(p.boxes.list.indexOf(st.element),1);c.box=null}}if(Ct(e,t),h&&"move"===h.type){bt(e,t)}if(l.drag&&!h){var ot=l.drag[0]+l.pos[0];var ut=l.drag[1]+l.pos[1];i.pos[0]=ot;i.pos[1]=ut}}function bt(e,t){var r=e.state,a=r.modes[0],n=a.unit,l=r.cursor,i=t.map,s=i.units.indexOf(n),o=e.sprites,u=r.cache,c=u.ranges[s],p=u.layers;if(p.markers.cursor&&a.path&&a.path.length){var f=a.path;var h=f[f.length-1];var v=h[0]*16;var d=h[1]*16;var m=p.markers.cursor,g=m.el,y=m.pos;y[0]+=(v-y[0])/4;y[1]+=(d-y[1])/4;g.style.left=y[0]+"px";g.style.top=y[1]+"px"}if(u.cursor.cell&&dt(u.cursor.cell,l.cell)){return}u.cursor.cell=l.cell;var w=a.path=L(i,n,l.cell,c,a.path);if(w.length){if(w.length>1){var x=ht(w);var b=o.ui.Arrow(w);var k=p.markers.arrow;if(!k){k=b;k.className="arrow";p.markers.arrow=k;p.markers.wrap.appendChild(k)}else{var C=k.getContext("2d");k.width=b.width;k.height=b.height;C.drawImage(b,0,0)}k.style.left=x.left*16+"px";k.style.top=x.top*16+"px"}else if(w.length===1){var I=p.markers.arrow;if(I){p.markers.arrow=null;p.markers.wrap.removeChild(I)}}var z=w[w.length-1];var A=z[0]*16;var S=z[1]*16;if(!p.markers.cursor){var M=ct(o.ui.cursor[0]);var E=[A,S];M.className="cursor";M.style.left=A+"px";M.style.top=S+"px";p.markers.wrap.appendChild(M);p.markers.cursor={el:M,pos:E}}}else{a.path=null;u.cursor.cell=null;var O=p.markers.cursor;if(O){p.markers.cursor=null;p.markers.wrap.removeChild(O.el)}var q=p.markers.arrow;if(q){p.markers.arrow=null;p.markers.wrap.removeChild(q)}}}function kt(e){if(!e.exiting){e.pos[0]+=(8-e.pos[0])/4}else{e.pos[0]-=24}var t=e.element;t.style.left=Math.round(e.pos[0])+"px",t.style.top=Math.round(e.pos[1])+"px"}function Ct(e,t){var r=e.state.viewport,a=e.state.cache.layers,n=[16*t.map.layout.size[0]-r.size[0],16*t.map.layout.size[1]-r.size[1]];if(r.dest&&(r.pos[0]+=(r.dest[0]-r.pos[0])/8,r.pos[1]+=(r.dest[1]-r.pos[1])/8),0<=n[0]&&0<=n[1]){var l=r.dest||r.pos;l[0]>-r.size[0]/2?l[0]=-r.size[0]/2:l[0]+r.size[0]/2<-n[0]&&(l[0]=-n[0]-r.size[0]/2),l[1]>-r.size[1]/2?l[1]=-r.size[1]/2:l[1]+r.size[1]/2<-n[1]&&(l[1]=-n[1]-r.size[1]/2)}var i=Math.round(r.pos[0]),s=Math.round(r.pos[1]);a.game.style.transform="translate("+i+"px, "+s+"px)"}function A(e){return{wrap:g("layer "+e),list:[]}}function W(e){return Math.floor(e/16)}function j(e){return 16*e+8}(C="sprites.png",new Promise(function(e,t){var r=new Image;r.src=C,r.onload=function(){e(r)},r.onerror=function(){t(new Error("Failed to load image `"+C+"`"))}})).then(function(e){var t=l(e),r=I({state:O,actions:q},t);document.body.appendChild(r.element)});var S,M,E,O={game:(M=(S=e).units.map(function(e){return function(e,t,r,a,n){return{name:e,type:t,faction:r,ai:a,cell:n,hp:3}}.apply(void 0,_toConsumableArray(e))}),E=M.filter(function(e){return"player"===e.faction}),{map:{layout:S.map,units:M},phase:{faction:"player",pending:E}})},q={game:{move:function(e,t,r){var a;a=r,t.cell=a.slice()},attack:function(e,t,r){}}}}();