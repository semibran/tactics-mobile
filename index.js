"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],a=!0,n=!1,i=void 0;try{for(var l,o=e[Symbol.iterator]();!(a=(l=o.next()).done)&&(r.push(l.value),!t||r.length!==t);a=!0);}catch(e){n=!0,i=e}finally{try{!a&&o.return&&o.return()}finally{if(n)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(){var a={piece:{shadow:[320,540,14,14],base:[240,512,16,16]},tiles:{grass:[560,0,16,16]},effects:{shockwave:[80,512,160,24],attack:[320,512,192,12]},ui:{cursor:[512,512,32,16],box:[512,0,48,48],squares:[512,48,32,16],arrows:[256,512,64,64],healthbar:[175,536,48,8],words:{player:[80,536,95,16],phase:[80,552,80,16],enemy:[320,524,82,16]},typeface:[0,512,80,64]},maps:{test:[256,0,256,512],"test-tree":[0,0,256,512]},icons:{target:[402,524,8,8],cursor:[80,568,8,8],wing:[160,552,8,8],dragon:[512,64,8,8],viking:[544,48,8,8],shield:[512,528,8,8],bow:[544,512,8,8],fuse:[240,536,8,8],element:[223,536,8,8],book:[240,528,8,8],boot:[560,16,8,8],puzzle:[320,554,8,8],"axe-2":[334,540,8,8],ice:[402,532,8,8],fire:[410,524,8,8],muscle:[88,568,8,8],dagger:[160,560,8,8],sword:[168,552,8,8],arrow:[512,72,8,8],sabre:[520,64,8,8],helmet:[544,56,8,8],thunder:[552,48,8,8],next:[512,536,8,8],eye:[520,528,8,8],clock:[544,520,8,8],axe:[552,512,8,8],"hat-2":[183,544,8,8],hat:[223,544,8,8],enemy:[231,536,8,8],lance:[175,544,8,8]}},Ee=function(e,t,r,a,n){t||(t=0),r||(r=0),a||(a=e.width),n||(n=e.height);var i=document.createElement("canvas"),l=i.getContext("2d");return i.width=a,i.height=n,l.drawImage(e,-t,-r),i};function qe(e,t){var r=document.createElement("canvas"),a=r.getContext("2d");return r.width=e,r.height=t,a}var c={get:function(e,t,r){var a=4*(r*e.width+t),n=e.data[a],i=e.data[a+1],l=e.data[a+2],o=e.data[a+3];return[n,i,l,o]},set:function(e,t,r,a){var n=4*(r*e.width+t);e.data[n+0]=a[0],e.data[n+1]=a[1],e.data[n+2]=a[2],e.data[n+3]=a[3]},replace:function(e,t,r){for(var a=0;a<e.data.length;a+=4){for(var n=0;n<4&&e.data[a+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[a+n]=r[n]}}},p={black:[0,0,0,255],gray:[168,168,168,255],white:[255,255,255,255],cyan:[144,224,232,255],blue:[80,120,248,255],navy:[88,24,216,255],pink:[248,192,224,255],red:[208,0,88,255],purple:[56,0,80,255],lime:[200,224,144,255],green:[40,192,32,255],teal:[0,96,112,255],yellow:[232,224,56,255]},Le={fighter:"axe",knight:"shield",thief:"dagger",mage:"hat",berserker:"viking",general:"helmet",assassin:"sabre",sorcerer:"hat-2"};function s(e,t,r){e=e.getContext("2d").getImageData(0,0,16,16),t=t.getContext("2d").getImageData(0,0,t.width,t.height),c.replace(e,p.white,r.default),c.replace(e,p.black,r.dark);var a=qe(e.width,e.height);a.putImageData(e,0,0);var n,i,l,o,s=qe(8,8);return c.replace(t,p.white,r.light),s.putImageData(t,0,0),a.drawImage(s.canvas,4,4),c.replace(t,r.light,r.dark),s.putImageData(t,0,0),a.drawImage(s.canvas,4,3),n=a.canvas,i=4,l=document.createElement("canvas"),o=l.getContext("2d"),l.width=n.width*i,l.height=n.height*i,o.webkitImageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,o.msImageSmoothingEnabled=!1,o.imageSmoothingEnabled=!1,o.drawImage(n,0,0,n.width*i,n.height*i),l}function Me(e){for(var t=1/0,r=1/0,a=-1/0,n=-1/0,i=0;i<e.length;i++){var l=e[i],o=l[0],s=l[1];o<t&&(t=o),a<o&&(a=o),s<r&&(r=s),n<s&&(n=s)}return{left:t,top:r,right:a,bottom:n,width:a-t+1,height:n-r+1}}var f=function(e,t,r,a,n){var i=document.createElement("canvas"),l=i.getContext("2d");return i.width=a,i.height=n,l.drawImage(e,-t,-r),i};function n(e){var t,r,L,a,o,i,l,n=(t=e.ui.cursor,[f(t,0,0,16,16),f(t,16,0,16,16)]),s=(r=e.ui.arrows,L={left:f(r,0,0,16,16),right:f(r,16,0,16,16),up:f(r,32,0,16,16),down:f(r,48,0,16,16),leftStub:f(r,0,16,16,16),rightStub:f(r,16,16,16,16),upStub:f(r,32,16,16,16),downStub:f(r,48,16,16,16),upLeft:f(r,0,32,16,16),upRight:f(r,16,32,16,16),downLeft:f(r,32,32,16,16),downRight:f(r,48,32,16,16),horiz:f(r,0,48,16,16),vert:f(r,16,48,16,16)},function(e){for(var t=[],r=0;r<e.length;r++){var a=_slicedToArray(e[r],2),n=a[0],i=a[1],l=!1,o=!1,s=!1,c=!1,u=e[r-1];if(u){var p=n-u[0],f=i-u[1];1===p?l=!0:-1===p&&(o=!0),1===f?s=!0:-1===f&&(c=!0)}var h=e[r+1];if(h){var d=h[0]-n,v=h[1]-i;-1===d?l=!0:1===d&&(o=!0),-1===v?s=!0:1===v&&(c=!0)}if(l||o||s||c){var m=null;l&&o?m="horiz":s&&c?m="vert":s&&l?m="upLeft":s&&o?m="upRight":c&&l?m="downLeft":c&&o?m="downRight":l&&!r?m="leftStub":o&&!r?m="rightStub":s&&!r?m="upStub":c&&!r?m="downStub":l?m="left":o?m="right":s?m="up":c&&(m="down"),m&&t.push({sprite:L[m],position:[n,i]})}}var g=Me(e),w=qe(16*g.width,16*g.height),y=!0,x=!1,b=void 0;try{for(var k,C=t[Symbol.iterator]();!(y=(k=C.next()).done);y=!0){var z=k.value,I=z.sprite,A=z.position,S=_slicedToArray(A,2),E=S[0],q=S[1];w.drawImage(I,16*(E-g.left),16*(q-g.top))}}catch(e){x=!0,b=e}finally{try{!y&&C.return&&C.return()}finally{if(x)throw b}}return w.canvas}),c=function(e){for(var t=e.width/8,r=e.height/8,s={},a=0,n=0;n<r;n++)for(var i=0;i<t;i++){var l="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/-+     "[a++];s[l]=f(e,8*i,8*n,8,8)}return function(e){for(var t=0,r=0;r<e.length;r++)" "===e[r]?t+=4:t+=8;for(var a=qe(t,8),n=0,i=0;n<e.length;n++){var l=e[n];if(" "===l)i+=4;else{var o=s[l];a.drawImage(o,i,0),i+=8}}return a.canvas}}(e.ui.typeface),u=(a=e.ui.box,o={topLeft:f(a,0,0,16,16),top:f(a,16,0,16,16),topRight:f(a,32,0,16,16),left:f(a,0,16,16,16),center:f(a,16,16,16,16),right:f(a,32,16,16,16),bottomLeft:f(a,0,32,16,16),bottom:f(a,16,32,16,16),bottomRight:f(a,32,32,16,16)},function(e,t){for(var r=Math.ceil(e/16),a=Math.ceil(t/16),n=qe(e,t),i=1;i<r-1;i++)n.drawImage(o.top,16*i,0),n.drawImage(o.bottom,16*i,t-16);for(var l=1;l<a-1;l++)n.drawImage(o.left,0,16*l),n.drawImage(o.right,e-16,16*l);return n.fillRect(4,4,e-8,t-8),n.drawImage(o.topLeft,0,0),n.drawImage(o.topRight,e-16,0),n.drawImage(o.bottomLeft,0,t-16),n.drawImage(o.bottomRight,e-16,t-16),n.canvas});return{Text:c,Box:u,TextBox:(i=c,l=u,function(e){var t=i(e),r=t.width,a=l(r+16,24),n=qe(r,8);return n.drawImage(t,0,0),n.canvas.width&&a.getContext("2d").drawImage(n.canvas,8,8),a}),Arrow:s,squares:function(){return{move:e(p.blue),attack:e(p.red),fuse:e(p.yellow)};function e(e){var t=qe(16,16);return t.fillStyle=function(e,t,r,a){return"rgba("+e+", "+t+", "+r+", "+a+")"}.apply(void 0,_toConsumableArray(e)),t.globalAlpha=.5,t.fillRect(0,0,15,15),t.canvas}}(),cursor:n}}function i(e){var t=function e(t,r){var a={};for(var n in r)if(Array.isArray(r[n])){var i=_slicedToArray(r[n],4),l=i[0],o=i[1],s=i[2],c=i[3];a[n]=Ee(t,l,o,s,c)}else a[n]=e(t,r[n]);return a}(e,a),r=function(e){var t={},r={player:{default:p.blue,light:p.cyan,dark:p.navy},enemy:{default:p.red,light:p.pink,dark:p.purple}};for(var a in r){var n=r[a];for(var i in Le){var l=Le[i],o=e.icons[l];t[i]||(t[i]={}),t[i][a]=s(e.piece.base,o,n)}}return t}(t);return{Piece:function(e,t){return Ee(r[e][t])},pieces:{shadow:t.piece.shadow},ui:n(t),effects:t.effects,tiles:t.tiles,icons:t.icons}}var t={name:"grass",walkable:!0},e={id:"test",map:{size:[12,16],data:"                                                                                                                                                                                                ".split("").map(function(e){switch(e){case" ":return t}})},units:[["Ulysses","knight","player",null,[4,6]],["Alice","mage","player",null,[3,9]],["Garrick","fighter","enemy",null,[8,7]]]};function z(e){var t=document.createElement("div");return t.className=e,t}var r={axe:{type:"axe",stat:"str",atk:2,hit:0,rng:1},lance:{type:"lance",stat:"str",atk:2,hit:1,rng:1},dagger:{type:"dagger",stat:"str",atk:1,hit:1,rng:1},tome:{type:"tome",stat:"int",atk:2,hit:1,rng:2}},l={leather:{def:1,wt:0},mail:{def:2,wt:1},plate:{def:3,wt:1}};function Oe(e,t){return e.faction===t.faction}function Re(e){var t=u[e].armor,r=t?t.wt:0;return 5+Math.floor(o[e].agi/3-r/2)}function Ne(e){return(t=e,u[t].weapon).rng;var t}var o={fighter:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:1},thief:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},u={fighter:{weapon:r.axe,armor:l.leather},knight:{weapon:r.lance,armor:l.mail},thief:{weapon:r.dagger,armor:l.leather},mage:{weapon:r.tome,armor:l.leather},berserker:{weapon:r.axe,armor:l.leather},general:{weapon:r.lance,armor:l.plate},assassin:{weapon:r.dagger,armor:l.leather},sorcerer:{weapon:r.tome,armor:l.leather}};function Te(e,t){return Math.abs(h(t)-h(e))+Math.abs(d(t)-d(e))}function h(e){return e[0]}function d(e){return e[1]}function _e(e,t){return h(e)===h(t)&&d(e)===d(t)}function De(e,t){for(var r=0;r<e.length;r++)if(_e(e[r],t))return r;return-1}function Be(e,t){t||(t=1);for(var r=[{steps:0,cell:e}],a=[];r.length;)for(var n=r.shift(),i=[[h(n.cell)-1,d(n.cell)],[h(n.cell)+1,d(n.cell)],[h(n.cell),d(n.cell)-1],[h(n.cell),d(n.cell)+1]],l=0;l<i.length;l++){var o=i[l];_e(e,o)||-1!==De(a,o)||(a.push(o),n.steps+1<t&&r.push({steps:n.steps+1,cell:o}))}return a}function Pe(e,t){var r={move:[t.cell],attack:[],fuse:[]},a="defend"===t.ai?0:Re(t.type),n=[{steps:0,cell:t.cell}],i=[];for(a||(n.length=0,i.push(t.cell));n.length;)for(var l=n.shift(),o=Be(l.cell),s=0;s<o.length;s++){if(g(e,p=o[s])&&-1===De(r.move,p)){if(f=Fe(e,p)){var c=Oe(t,f)?r.fuse:r.attack;f.type!==t.type&&c===r.fuse||-1===De(c,p)&&c.push(p)}else r.move.push(p);l.steps<a-1?f&&!Oe(t,f)||n.push({steps:l.steps+1,cell:p}):i.push(p)}}for(s=0;s<i.length;s++){o=Be(i[s],Ne(t.type));for(var u=0;u<o.length;u++){var p,f;if(m(e,p=o[u])&&g(e,p)&&!_e(t.cell,p))(f=Fe(e,p))&&Oe(t,f)||-1===De(r.attack,p)&&r.attack.push(p),(!f||Oe(t,f)&&t.type===f.type)&&-1===De(r.fuse,p)&&r.fuse.push(p)}}return r}function v(e){return e.layout.size[0]}function m(e,t){return 0<=h(t)&&h(t)<v(e)&&0<=d(t)&&d(t)<e.layout.size[1]}function Fe(e,t){for(var r=0;r<e.units.length;r++){var a=e.units[r];if(_e(a.cell,t))return a}}function g(e,t){return m(e,t)&&(r=e,a=t,r.layout.data[d(a)*v(r)+h(a)]).walkable;var r,a}function He(e,t,r){for(var a=[],n=[t],i={},l={},o={},s={},c={},u=0;u<e.length;u++){var p=e[u];s[p]=1/0,c[p]=1/0}for(s[t]=0,c[t]=Te(t,r);n.length;){var f={score:1/0,index:-1,cell:null};for(u=0;u<n.length;u++){(v=c[h=n[u]])<f.score&&(f.score=v,f.index=u,f.cell=h)}var h;if(_e(h=f.cell,r)){for(;!_e(h,t);)a.unshift(h),h=o[h];return a.unshift(h),a}n.splice(f.index,1),i[h]=!1,l[h]=!0;var d=Be(h);for(u=0;u<d.length;u++){var v,m=d[u];if(-1!==De(e,m))if(!l[m])i[m]||(i[m]=!0,n.push(m)),(v=s[h]+1)>=s[m]||(o[m]=h,s[m]=v,c[m]=v+Te(m,r))}}return[]}function We(e,t){var r=t*(e.length-1),a=Math.floor(r),n=r-a;if(1===t)return e[a];var i=e[a],l=e[a+1];return[i[0]+(l[0]-i[0])*n,i[1]+(l[1]-i[1])*n]}var w,I=2;function y(e,t){var r=e.state,a=(e.actions,{sprites:t,element:document.createElement("main"),state:{time:0,cursor:{position:null,drag:null},selection:null,viewport:{size:[window.innerWidth/I,window.innerHeight/I],position:[8,8]},anims:[],cache:{box:null,elements:{},ranges:[],cursor:{cell:null,unit:null}}}});return function(t,r,e){var c=t.state,u=r.map,a=t.sprites,p=c.cursor,f=c.viewport,h=c.anims,d=c.cache,v=d.elements;v.game=z("game"),v.map=function(e,t){var r=16*t.layout.size[0],a=16*t.layout.size[1],n=qe(r,a);n.canvas.className="map";for(var i=0;i<t.layout.size[1];i++)for(var l=0;l<t.layout.size[0];l++)n.drawImage(e.tiles.grass,16*l,16*i);return n.canvas}(a,u),v.ui=z("ui");var n=u.units[0];n&&(f.position[0]=-q(n.cell[0]),f.position[1]=-q(n.cell[1]),Ge(t,r));v.shadows=S("shadows"),v.squares=S("squares"),v.boxes=S("boxes"),v.markers={wrap:z("layer markers"),arrow:null,cursor:null},v.pieces={wrap:z("layer pieces"),list:[],selection:{z:0}},v.selection={wrap:z("layer selection"),piece:null,z:0};var i=!0,l=!1,o=void 0;try{for(var s,m=u.units[Symbol.iterator]();!(i=(s=m.next()).done);i=!0){var g=s.value,w=16*g.cell[0],y=16*g.cell[1],x=a.Piece(g.type,g.faction);x.className="piece",x.style.left=w+"px",x.style.top=y-1+"px",v.pieces.wrap.appendChild(x),v.pieces.list.push(x);var b=Ee(a.pieces.shadow);b.className="shadow",b.style.left=w+1+"px",b.style.top=y+3+"px",v.shadows.wrap.appendChild(b),v.shadows.list.push(b)}}catch(e){l=!0,o=e}finally{try{!i&&m.return&&m.return()}finally{if(l)throw o}}function k(e){var t=e.changedTouches[0];return[t.pageX/I,t.pageY/I]}function C(e){var t=v.game.getBoundingClientRect();return[e[0]-t.left/I,e[1]-t.top/I]}v.game.appendChild(v.map),v.game.appendChild(v.squares.wrap),v.game.appendChild(v.shadows.wrap),v.game.appendChild(v.pieces.wrap),v.game.appendChild(v.markers.wrap),v.game.appendChild(v.selection.wrap),v.ui.appendChild(v.boxes.wrap),t.element.appendChild(v.game),t.element.appendChild(v.ui),function e(){A(t,r);requestAnimationFrame(e)}(),t.element.addEventListener("touchstart",function(e){var t=p.position=k(e),r=p.cell=C(p.position).map(E),a=Fe(u,r);if(a){var n=u.units.indexOf(a),i=v.pieces.list[n];c.selection||h.length?a!==c.selection.unit&&(c.selection=null):(c.selection={unit:a,time:c.time},p.drag=[parseInt(i.style.left)-t[0],parseInt(i.style.top)-t[1]])}else{if(c.selection){var l=c.selection.unit,o=u.units.indexOf(l),s=d.ranges[o];v.pieces.list[o];-1===De(s.move,r)?c.selection=null:p.drag=[16*r[0]-t[0],16*r[1]-t[1]]}c.selection||(p.drag=[f.position[0]-t[0],f.position[1]-t[1]])}}),t.element.addEventListener("touchmove",function(e){e.preventDefault(),p.position=k(e),p.cell=C(p.position).map(E)}),t.element.addEventListener("touchend",function(e){if(p.position=k(e),p.cell=C(p.position).map(E),p.drag=null,c.selection){var t=c.selection.unit,r=c.path;if(r&&r.length){var a=r[r.length-1],n=Fe(u,p.cell);!n&&_e(p.cell,a)&&function(e,t){u.units.indexOf(e);d.ranges.length=0,c.path=null,e.cell=t[t.length-1].slice(),h.push({type:"move",unit:e,path:t,time:c.time})}(t,r),t!==n&&(c.selection=null)}else if(v.selection.piece){var i=v.selection.piece;v.selection.piece=null,v.selection.wrap.removeChild(i),v.shadows.wrap.removeChild(v.shadows.list.pop())}}}),window.addEventListener("resize",function(e){f.size[0]=window.innerWidth/I,f.size[1]=window.innerHeight/I,console.log(f.size)}),window.addEventListener("contextmenu",function(e){return e.preventDefault(),!1})}(a,r.game),a}function A(e,t){var r=t.map,a=e.sprites,n=e.state,i=n.cursor,l=n.viewport,o=n.cache,s=n.anims,c=o.elements,u=++n.time;if(!o.selection&&n.selection||o.selection&&!n.selection||n.selection&&o.selection!==n.selection.unit){if(o.selection){var p=o.selection;var f=r.units.indexOf(p);var h=p.cell[0]*16;var d=p.cell[1]*16;if(c.selection.piece){var v=c.selection.piece;c.selection.piece=null;c.selection.z=0;c.selection.wrap.removeChild(v);c.shadows.wrap.removeChild(c.shadows.list.pop())}if(!s.length){var m=c.shadows.list[f];m.style.left=h+1+"px";m.style.top=d+3+"px";var g=c.pieces.list[f];g.style.left=h+"px";g.style.top=d-1+"px";c.pieces.wrap.appendChild(g)}var w=true;var y=false;var x=undefined;try{for(var b=c.squares.list[Symbol.iterator](),k;!(w=(k=b.next()).done);w=true){var C=k.value;c.squares.wrap.removeChild(C)}}catch(e){y=true;x=e}finally{try{if(!w&&b.return){b.return()}}finally{if(y){throw x}}}c.squares.list.length=0;var z=c.markers.cursor;if(z){c.markers.wrap.removeChild(z.element);c.markers.cursor=null}if(!s.length){var I=c.markers.arrow;if(I){c.markers.wrap.removeChild(I);c.markers.arrow=null}}}if(n.selection){var A=n.selection.unit;var S=r.units.indexOf(A);var E=c.pieces.list[S];c.selection.wrap.appendChild(E);var q=o.ranges[S];if(!q){q=o.ranges[S]=Pe(r,A)}var L=Array.prototype.concat(q.move,q.attack);var M=Me(L);var O=qe(M.width*16,M.height*16);var R=true;var N=false;var T=undefined;try{for(var _=q.move[Symbol.iterator](),D;!(R=(D=_.next()).done);R=true){var B=D.value;if(_e(B,A.cell))continue;var P=(B[0]-M.left)*16;var F=(B[1]-M.top)*16;O.drawImage(a.ui.squares.move,P,F)}}catch(e){N=true;T=e}finally{try{if(!R&&_.return){_.return()}}finally{if(N){throw T}}}var H=true;var W=false;var j=undefined;try{for(var G=q.attack[Symbol.iterator](),U;!(H=(U=G.next()).done);H=true){var X=U.value;if(De(q.move,X)!==-1)continue;var Y=(X[0]-M.left)*16;var J=(X[1]-M.top)*16;O.drawImage(a.ui.squares.attack,Y,J)}}catch(e){W=true;j=e}finally{try{if(!H&&G.return){G.return()}}finally{if(W){throw j}}}O.canvas.className="range";O.canvas.style.left=M.left*16+"px";O.canvas.style.top=M.top*16+"px";c.squares.wrap.appendChild(O.canvas);c.squares.list.push(O.canvas);o.selection=A}else{o.selection=null}if(o.box){o.box.exiting=true}}if(n.selection){var K=n.selection;var Q=K.unit;var V=r.units.indexOf(Q);var Z=c.pieces.list[V];var $=u-K.time;if($>6){var ee=($-6)%120/120;$=Math.round(6+Math.sin(2*Math.PI*ee)*2)}Z.style.left=Q.cell[0]*16+"px";Z.style.top=Q.cell[1]*16-$+"px";if(!o.box){var te=a.ui.Box(Q.name.length*8+12+16,8+16);var re=a.ui.Text(Q.name);var ae=a.icons[Le[Q.type]];var ne=te.getContext("2d");ne.drawImage(ae,8,8);ne.drawImage(re,20,8);te.className="box";var ie={position:[-te.width,l.size[1]-te.height-8],element:te,exiting:false};c.boxes.wrap.appendChild(ie.element);c.boxes.list.push(ie.element);o.box=ie}if(i.drag){if(!c.selection.piece){var le=c.pieces.list[V];var oe=Ee(le);oe.className="ghost piece";oe.style.display="none";c.selection.piece=oe;c.selection.wrap.appendChild(oe);var se=Ee(a.pieces.shadow);se.className="ghost shadow";c.shadows.list.push(se);c.shadows.wrap.appendChild(se)}var ce=i.drag[0]+i.position[0];var ue=i.drag[1]+i.position[1];var pe=c.selection.piece;var fe=c.shadows.list[c.shadows.list.length-1];c.selection.z+=(12-c.selection.z)/4;if(!_e(i.cell,Q.cell)){var he=c.selection.z;pe.style.left=ce+"px";pe.style.top=ue-he+"px";pe.style.display="block";fe.style.left=ce+1+"px";fe.style.top=ue+4+"px";fe.style.display="block"}else{pe.style.display="none";fe.style.display="none"}}}if(o.box){var de=o.box;je(de);if(de.position[0]<-de.element.width-16*15){c.boxes.wrap.removeChild(de.element);c.boxes.list.splice(c.boxes.list.indexOf(de.element),1);o.box=null}}if(Ge(e,t),function(e,t){if(!e.state.selection)return;var r=e.state,a=r.selection.unit,n=r.cursor,i=t.map,l=i.units.indexOf(a),o=e.sprites,s=r.cache,c=s.ranges[l],u=s.elements;if(u.markers.cursor&&r.path&&r.path.length){var p=r.path,f=p[p.length-1],h=16*f[0],d=16*f[1],v=u.markers.cursor,m=v.element,g=v.position;g[0]+=(h-g[0])/4,g[1]+=(d-g[1])/4,m.style.left=g[0]+"px",m.style.top=g[1]+"px"}if(s.cursor.cell&&_e(s.cursor.cell,n.cell))return;s.cursor.cell=n.cell;var w=r.path=function(e,r,t,a,n){if(_e(t,r.cell))return[t];var i=a.move.slice(),l=!0,o=!1,s=void 0;try{for(var c,u=e.units[Symbol.iterator]();!(l=(c=u.next()).done);l=!0){var p=c.value;Oe(r,p)&&!_e(r.cell,p.cell)&&(Te(r.cell,p.cell)>Re(r.type)||i.push(p.cell))}}catch(e){o=!0,s=e}finally{try{!l&&u.return&&u.return()}finally{if(o)throw s}}var f=t,h=Fe(e,t);if(h){var d=Oe(r,h)?Be(h.cell):Be(h.cell,Ne(r.type));if(n){var v=d.filter(function(e){return-1!==De(n,e)});v.length&&(f=v.sort(function(e,t){return n.indexOf(e)-n.indexOf(t)})[0])}f||(f=d.filter(function(e){return-1!==De(i,e)}).sort(function(e,t){return Te(r.cell,e)-Te(r.cell,t)})[0])}if(!n)return He(i,r.cell,f);if(_e(f,n[n.length-1]))return n;var m=De(n,f);if(-1!==m)return n.slice(0,m+1);var g=He(i.filter(function(e){return-1===De(n,e)}),n[n.length-1],f);return g.length?g&&n.length+g.length-2<=Re(r.type)?(g.shift(),[].concat(_toConsumableArray(n),_toConsumableArray(g))):He(i,r.cell,f):[]}(i,a,n.cell,c,r.path);if(w.length){if(1<w.length){var y=Me(w),x=o.ui.Arrow(w),b=u.markers.arrow;if(b){var k=b.getContext("2d");b.width=x.width,b.height=x.height,k.drawImage(x,0,0)}else(b=x).className="arrow",u.markers.arrow=b,u.markers.wrap.appendChild(b);b.style.left=16*y.left+"px",b.style.top=16*y.top+"px"}else if(1===w.length){var C=u.markers.arrow;C&&(u.markers.arrow=null,u.markers.wrap.removeChild(C))}var z=w[w.length-1],I=16*z[0],A=16*z[1];if(!u.markers.cursor){var S=Ee(o.ui.cursor[0]),E=[I,A];S.className="cursor",S.style.left=I+"px",S.style.top=A+"px",u.markers.wrap.appendChild(S),u.markers.cursor={element:S,position:E}}}else{r.path=null;var q=u.markers.cursor;q&&(u.markers.cursor=null,u.markers.wrap.removeChild(q.element));var L=u.markers.arrow;L&&(u.markers.arrow=null,u.markers.wrap.removeChild(L))}}(e,t),i.drag){var ve=i.drag[0]+i.position[0];var me=i.drag[1]+i.position[1];if(!n.selection){l.position[0]=ve;l.position[1]=me}}var ge=s[0];if(ge){var we=u-ge.time;var ye=ge.path;var xe=we/ye.length/2;var be=We(ye,xe);var ke=be[0]*16;var Ce=be[1]*16;var ze=r.units.indexOf(ge.unit);var Ie=c.pieces.list[ze];Ie.style.left=ke+"px";Ie.style.top=Ce+"px";var Ae=c.shadows.list[ze];Ae.style.left=ke+1+"px";Ae.style.top=Ce+4+"px";var Se=c.markers.arrow;if(Se){if(Se.style.display==="block"){Se.style.display="none"}else{Se.style.display="block"}}if(xe===1){s.shift();c.pieces.wrap.appendChild(Ie);c.markers.wrap.removeChild(Se);c.markers.arrow=null}}}function je(e){if(!e.exiting){e.position[0]+=(8-e.position[0])/4}else{e.position[0]-=24}var t=e.element;t.style.left=Math.round(e.position[0])+"px",t.style.top=Math.round(e.position[1])+"px"}function Ge(e,t){var r=e.state.viewport,a=e.state.cache.elements,n=[16*t.map.layout.size[0]-r.size[0],16*t.map.layout.size[1]-r.size[1]];0<=n[0]&&0<=n[1]&&(r.position[0]>-r.size[0]/2?r.position[0]=-r.size[0]/2:r.position[0]+r.size[0]/2<-n[0]&&(r.position[0]=-n[0]-r.size[0]/2),r.position[1]>-r.size[1]/2?r.position[1]=-r.size[1]/2:r.position[1]+r.size[1]/2<-n[1]&&(r.position[1]=-n[1]-r.size[1]/2));var i=r.position[0],l=r.position[1];a.game.style.transform="translate("+i+"px, "+l+"px)"}function S(e){return{wrap:z("layer "+e),list:[]}}function E(e){return Math.floor(e/16)}function q(e){return 16*e+8}(w="sprites.png",new Promise(function(e,t){var r=new Image;r.src=w,r.onload=function(){e(r)},r.onerror=function(){t(new Error("Failed to load image `"+w+"`"))}})).then(function(e){var t=i(e),r=y({state:C,actions:L},t);document.body.appendChild(r.element)});var x,b,k,C={game:(b=(x=e).units.map(function(e){return function(e,t,r,a,n){return{name:e,type:t,faction:r,ai:a,cell:n,hp:3}}.apply(void 0,_toConsumableArray(e))}),k=b.filter(function(e){return"player"===e.faction}),{map:{layout:x.map,units:b},phase:{faction:"player",pending:k}})},L={game:{move:function(e,t,r){var a;a=r,t.cell=a.slice()},attack:function(e,t,r){}}}}();